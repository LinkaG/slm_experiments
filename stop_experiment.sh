#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ñ–æ–Ω–æ–≤–æ–≥–æ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./stop_experiment.sh [PID_FILE]

LOG_DIR="./logs"

if [ -z "$1" ]; then
    # –ò—â–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π PID —Ñ–∞–π–ª
    PID_FILE=$(ls -t ${LOG_DIR}/*.pid 2>/dev/null | head -1)
    if [ -z "$PID_FILE" ]; then
        echo "‚ùå PID —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ ${LOG_DIR}"
        echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: $0 [PID_FILE]"
        exit 1
    fi
else
    PID_FILE="$1"
fi

if [ ! -f "$PID_FILE" ]; then
    echo "‚ùå PID —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω: $PID_FILE"
    exit 1
fi

PID=$(cat "$PID_FILE")

if [ -z "$PID" ]; then
    echo "‚ùå PID —Ñ–∞–π–ª –ø—É—Å—Ç: $PID_FILE"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ø—Ä–æ—Ü–µ—Å—Å
if ! ps -p "$PID" > /dev/null 2>&1; then
    echo "‚ö†Ô∏è  –ü—Ä–æ—Ü–µ—Å—Å —Å PID $PID –Ω–µ –Ω–∞–π–¥–µ–Ω (–≤–æ–∑–º–æ–∂–Ω–æ, —É–∂–µ –∑–∞–≤–µ—Ä—à–µ–Ω)"
    rm -f "$PID_FILE"
    exit 0
fi

echo "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞ (PID: $PID)..."
kill "$PID"

# –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–∞
for i in {1..10}; do
    if ! ps -p "$PID" > /dev/null 2>&1; then
        echo "‚úÖ –≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
        rm -f "$PID_FILE"
        exit 0
    fi
    sleep 1
done

# –ï—Å–ª–∏ –ø—Ä–æ—Ü–µ—Å—Å –≤—Å–µ –µ—â–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∑–∞–≤–µ—Ä—à–∞–µ–º
if ps -p "$PID" > /dev/null 2>&1; then
    echo "‚ö†Ô∏è  –ü—Ä–æ—Ü–µ—Å—Å –Ω–µ –∑–∞–≤–µ—Ä—à–∏–ª—Å—è, –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞..."
    kill -9 "$PID"
    sleep 1
    if ! ps -p "$PID" > /dev/null 2>&1; then
        echo "‚úÖ –≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ"
        rm -f "$PID_FILE"
    else
        echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–æ—Ü–µ—Å—Å"
        exit 1
    fi
fi

